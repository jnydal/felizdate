var ServerHandler=new Class({Extends:AbstractObject,getClassName:function(){return"ServerHandler"},initialize:function(){this.SERVER_RETRY_LIMIT=10000;this.transmissionErrors=0;this.firstPoll=true;this.AsyncConfig={id:null,lastMessageTime:1,focus:true,unread:0}},initPushServer:function(){Modernizr.load({test:!Modernizr.websockets&&Browser.Platform.android,yep:"websockets-android.js"});if(WebSocket){this.websocket=new WebSocket("ws://www.felizdate.no/socket");var a=this;this.websocket.onopen=function(){};this.websocket.onmessage=function(c){var b={payload:[JSON.parse(c.data)]};a.handlePushResponse(b)}}else{this.longPoll()}},nativeSubmitForm:function(a){if(!instanceOf(a,Form)){throw new Exception("form parameter is not a Form instance.")}a.getHtmlElement().submit()},longPoll:function(b){if(this.transmissionErrors>2){return}if(b&&b.payload){this.handlePushResponse(b);if(this.firstPoll){this.firstPoll=false}}var a=function(){this.transmissionErrors+=1;this.longPoll()}.bind(this);var c=new Request.JSON({url:"/async/recv/",method:"GET",data:{since:this.AsyncConfig.lastMessageTime},onRequest:function(){},onSuccess:function(d){this.transmissionErrors=0;this.longPoll(d)}.bind(this),onFailure:a,onTimeout:a}).send()},performAction:function(b){if(!instanceOf(b,ActionRequest)){throw new Exception("request parameter is not a ActionRequest instance.")}var c=b.getPayload();var a=new Request.JSON({url:"/action/"+b.actionName+"/",method:b.getMethod()||"post",data:c,onRequest:function(){},onSuccess:function(d){if(d.success){this.handleResponse(new ServerResponse(b,d.payload))}else{if(d.fielderrors){this.handleResponse(new FailureServerResponse(b,"FIELD_ERRORS",{fields:d.fielderrors}))}else{this.handleResponse(new FailureServerResponse(b,"SERVER_ERROR",{errors:d.errors}))}}}.bind(this),onFailure:function(d){this.handleResponse(new FailureServerResponse(b,"REQUEST_ERROR",{message:"Server request failed."}))}.bind(this),onTimeout:function(){this.handleResponse(new FailureServerResponse(b,"TIMEOUT",{message:"Request timeout."}))}.bind(this)}).send()},handleResponse:function(a){if(a instanceof FailureServerResponse){alert("Failed to execute "+a.request.actionName+" action.")}else{alert("Execution of "+a.request.actionName+" action was successful.")}},handlePushResponse:function(a){}});var ServerResponse=new Class({Extends:AbstractObject,initialize:function(b,a){if(!instanceOf(b,ActionRequest)){throw new Exception("request parameter is not a ActionRequest instance.")}this.request=b;this.payload=a},getClassName:function(){return"ServerResponse"},getRequest:function(){return this.request},getPayload:function(){return this.payload},toString:function(){return this.getClassName()+":<request="+this.request+">"}});var FailureServerResponse=new Class({Extends:ServerResponse,initialize:function(b,c,a){this.parent(b,a);if(typeof c!=="string"){throw new Exception("Expected string value for failure type, but was: <"+c+">.")}this.failureType=c},getClassName:function(){return"FailureServerResponse"},getFailureType:function(){return this.failureType},toString:function(){return this.getClassName()+":<request="+this.request+',failureType="'+this.failureType+'">'}});var CommunicationHandler=new Class({Extends:AbstractObject,getClassName:function(){return"CommunicationHandler"},performAction:function(d){if(!(d instanceof ActionRequest)){throw new Exception("Expected instance of ActionRequest, but was: <"+d+">.")}var c;switch(d.actionName){case"getRepositoryFolderContent":var b=d.getPayload().folderId;var a=MockedServer.getRepositoryFolderContent(b);if(a==null){c=new FailureServerResponse(d,"FOLDER_NOT_FOUND",{message:"Failed to find folder with id: <"+b+">."})}else{c=new ServerResponse(d,a)}break;default:c=new FailureServerResponse(d,"REQUEST_ERROR",{message:"Action is not known: <"+d.getActionName()+">."})}setTimeout(function(){this.handleResponse(c)}.bind(this),250)},handleResponse:function(a){if(a instanceof FailureServerResponse){alert("Failed to execute "+a.request.actionName+" action.")}else{alert("Execution of "+a.request.actionName+" action was successful.")}}});var MockedServer=new function(){var a=[{id:"0",text:"Main",type:"folder",content:[{id:"1",text:"Wizard",type:"wizard"},{id:"2",text:"Wizard2",type:"wizard"},{id:"3",text:"Wizard3",type:"wizard"},{id:"4",text:"other",type:"folder",content:[{id:"5",text:"Wizard4",type:"wizard"},{id:"6",text:"Wizard5",type:"wizard"},{id:"7",text:"Wizard6",type:"wizard"}]}]},{id:"8",text:"Extra",type:"folder",content:[{id:"9",text:"more",type:"folder",content:[{id:"12",text:"Wizard13",type:"wizard"},{id:"13",text:"Wizard14",type:"wizard"},{id:"14",text:"Wizard15",type:"wizard"}]},{id:"10",text:"Wizard8",type:"wizard"},{id:"11",text:"Wizard9",type:"wizard"}]}];this.getRepositoryFolderContent=function(d){if(d==null){return c(a)}var e=b(d,a);if(e==null){return null}return c(e)};function c(e){var d=[];for(var h=0;h<e.length;h++){var g=e[h];var f={};f.isFolder=(g.type==="folder");f.id=g.id;f.name=g.text;d.push(f)}return d}function b(h,d){for(var f=0;f<d.length;f++){var e=d[f];if(e.type==="folder"){if(e.id===h){return e.content}var g=b(h,e.content);if(g!=null){return g}}}return null}};
